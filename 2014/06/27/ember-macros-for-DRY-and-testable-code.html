<!DOCTYPE html><html><head><title>Ember Macros for DRY and Testable Code</title><link href="/stylesheets/all-84f1eb0e.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-ce68a29a.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - ' name='description'><meta content='linstula' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/2014/06/27/ember-macros-for-DRY-and-testable-code.html' name='twitter:url'><meta content='Ember Macros for DRY and Testable Code' name='twitter:title'><meta name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><link href='/atom.xml' rel='alternate' title='DockYard - Reefpoints' type='application/atom+xml'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO,        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='x2014 x2014_06 x2014_06_27 x2014_06_27_ember-macros-for-DRY-and-testable-code'><header><div class='extended-nav-wrap'><div class='l-wrap--wide'><nav class='extended-nav'><a class="extended-nav--logo" data-icon="⌂" href="http://dockyard.com/"><span class='is-hidden'>Home</span></a>
<a class="extended-nav--close" data-icon="X" href="#"><span class='is-hidden'>Close</span></a><div class='extended-nav__items'><div class='extended-nav__items--mobile'><a class="extended-nav__item--work extended-nav__item" href="#">Work</a><nav class='work-nav--mobile'><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong></a>
<a href="http://dockyard.com/work/scratch" class="work-nav-item"><strong class='work-nav-item__title'>Scratch Wireless</strong></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong></a></nav></div><a class="extended-nav__item" href="http://dockyard.com/team">Our Team</a><a class="extended-nav__item" href="http://dockyard.com/process">Process</a><a class="extended-nav__item" href="http://dockyard.com/community">Community</a><a class="extended-nav__item active" href="/">Blog</a><a class="extended-nav__item" href="http://dockyard.com/hire-us">Hire Us</a></div></nav><nav class='work-nav'><h6>Selected Work</h6><a href="http://dockyard.com/work/credit-card-reviews" class="work-nav-item"><strong class='work-nav-item__title'>Credit Card Reviews</strong><p>Credit card advice from real people.</p></a>
<a href="http://dockyard.com/work/scratch" class="work-nav-item"><strong class='work-nav-item__title'>Scratch Wireless</strong><p>Never pay another penny for smartphone service.</p></a>
<a href="http://dockyard.com/work/coachup" class="work-nav-item"><strong class='work-nav-item__title'>CoachUp</strong><p>You should be training. Right now.</p></a>
<a href="http://dockyard.com/work/askthem" class="work-nav-item"><strong class='work-nav-item__title'>AskThem</strong><p>Ask officials questions on city, state, and federal levels.</p></a>
<a href="http://dockyard.com/work/beacon-hill-blitz" class="work-nav-item"><strong class='work-nav-item__title'>Beacon Hill Blitz</strong><p>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap'><div class='main-nav l-wrap--wide'><a class="logo" href="http://dockyard.com">DockYard</a><a class="club-sandwich" data-icon="☰" href="#"><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap--blog'><a href="/"><strong class='logo--blog'>ReefPoints</strong><strong class='logo--blog__tagline'>Blog</strong></a><nav class='blog-nav'><a class="blog-nav__item " href="/">Posts</a><a class="blog-nav__item " href="/categories.html">Categories</a><a class="blog-nav__item " href="/authors.html">Authors</a></nav></div><div class='l-wrap--blog__post'><h1 class='post__title'>Ember Macros for DRY and Testable Code</h1><a class="post__author" href="/authors/lin-reid.html">Lin Reid</a><time class='post__date'>June 27<sup>th</sup>, 2014</time><div class='post__content'><h3>Intro</h3>

<p>This post in going to explore the idea of writing your own Ember macros
as a strategy for DRYing up and creating more modular Ember code. 
As you&#39;ll see, besides the maintainability and flexibility benefits gained by DRYing
up and decoupling code, isolated code is significantly easier to test.
We&#39;ll be using a sample application to illustrate refactoring some code
into a macro.</p>

<h3>What is a Computed Property Macro?</h3>

<p>A computed property macro can really be thought of as a function that returns the
definition of a computed property. Essentially, we are creating a function that will
define computed properties for us. They look something like this:</p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
</pre></td>
  <td class="code"><pre><span class="comment">// Defining a computed property macro</span>
<span class="keyword">function</span> <span class="function">greeting</span>(dependentKey, greeting) {
  <span class="keyword">return</span> Ember.computed(dependentKey, <span class="keyword">function</span>() {
    <span class="keyword">return</span> greeting + <span class="string"><span class="delimiter">'</span><span class="content">, </span><span class="delimiter">'</span></span> + dependentKey;
  });
}

<span class="comment">// Consuming a computed property macro</span>
<span class="keyword">var</span> Greeter = Ember.Object.extend({
  <span class="key">user</span>: <span class="predefined-constant">null</span>,
  <span class="key">englishGreeting</span>: greeting(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Hello</span><span class="delimiter">'</span></span>),
  <span class="key">spanishGreeting</span>: greeting(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Hola</span><span class="delimiter">'</span></span>)
});

<span class="keyword">var</span> concierge = Greeter.create({ <span class="key">user</span>: <span class="string"><span class="delimiter">'</span><span class="content">Narwin</span><span class="delimiter">'</span></span> });
concierge.get(<span class="string"><span class="delimiter">'</span><span class="content">englishGreeting</span><span class="delimiter">'</span></span>) <span class="comment">// =&gt; 'Hello, Narwin'</span>
concierge.get(<span class="string"><span class="delimiter">'</span><span class="content">spanishGreeting</span><span class="delimiter">'</span></span>) <span class="comment">// =&gt; 'Hola, Narwin'</span>

concierge.set(<span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Boomer</span><span class="delimiter">'</span></span>);
concierge.get(<span class="string"><span class="delimiter">'</span><span class="content">englishGreeting</span><span class="delimiter">'</span></span>) <span class="comment">// =&gt; 'Hello, Boomer'</span>
concierge.get(<span class="string"><span class="delimiter">'</span><span class="content">spanishGreeting</span><span class="delimiter">'</span></span>) <span class="comment">// =&gt; 'Hola, Boomer'</span>
</pre></td>
</tr></table>
</div></div>
<p>So, why not just use a standard computed property? Macros give us the
ability to take common chunks of functionality and share them throughout
our code, allowing us to avoid re-writing the logic every time we need
it. </p>

<p>Ember provides us with a bunch of useful computed macros
right out of the box. If you&#39;re not familiar with them, you should
definitely <a href="http://emberjs.com/api/#method_computed">check them out</a>.</p>

<p>Now that we&#39;ve covered our bases, lets move on to the sample app.</p>

<h3>Sample App</h3>

<p>The goal of our sample application is to track financial transactions
and to provide an overview of income and expenses for a given time frame.
Our app has a <code>Month</code> model which has many <code>transactions</code>. A <code>Month</code> also
has <code>incomeTransactions</code> (transactions with positive amounts) and
<code>expenseTransactions</code> (transactions with negative amounts). Below are
tests and code for our <code>Month</code> and <code>Transaction</code> models.</p>

<p><code>app/models/month.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span class="keyword">var</span> hasMany = DS.hasMany;
<span class="keyword">var</span> filter = Ember.computed.filter;

<span class="reserved">export</span> <span class="keyword">default</span> DS.Model.extend({
  <span class="key">transactions</span>: hasMany(<span class="string"><span class="delimiter">'</span><span class="content">transaction</span><span class="delimiter">'</span></span>),

  <span class="key">incomeTransactions</span>: filter(<span class="string"><span class="delimiter">'</span><span class="content">transactions</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(transaction) {
      <span class="comment">// Grab all transactions with a positive amount.</span>
      <span class="keyword">return</span> transaction.get(<span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>) &gt; <span class="integer">0</span>;
    }
  ),

  <span class="key">expenseTransactions</span>: filter(<span class="string"><span class="delimiter">'</span><span class="content">transactions</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(transaction) {
      <span class="comment">// Grab all transactions with a negative amount.</span>
      <span class="keyword">return</span> transaction.get(<span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>) &lt; <span class="integer">0</span>;
    }
  )
});
</pre></td>
</tr></table>
</div></div>
<p><code>tests/unit/models/month-test.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
24
25
26
27
28
29
<strong>30</strong>
31
32
33
34
35
36
37
38
39
<strong>40</strong>
41
42
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { test, moduleForModel } from <span class="string"><span class="delimiter">'</span><span class="content">ember-qunit</span><span class="delimiter">'</span></span>;

<span class="keyword">var</span> store, month, transactions, tran1, tran2, tran3, tran4;

moduleForModel(<span class="string"><span class="delimiter">'</span><span class="content">month</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Unit - Month Model</span><span class="delimiter">'</span></span>, {
  <span class="key">needs</span>: [<span class="string"><span class="delimiter">'</span><span class="content">model:transaction</span><span class="delimiter">'</span></span>],

  <span class="function">setup</span>: <span class="keyword">function</span>(container) {
    store = container.lookup(<span class="string"><span class="delimiter">'</span><span class="content">store:main</span><span class="delimiter">'</span></span>);

    month = <span class="local-variable">this</span>.subject({
      <span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">June</span><span class="delimiter">'</span></span>
    });

    Ember.run(<span class="keyword">function</span>() {
      tran1 = store.createRecord(<span class="string"><span class="delimiter">'</span><span class="content">transaction</span><span class="delimiter">'</span></span>, { <span class="key">amount</span>: <span class="integer">100</span> });
      tran2 = store.createRecord(<span class="string"><span class="delimiter">'</span><span class="content">transaction</span><span class="delimiter">'</span></span>, { <span class="key">amount</span>: <span class="integer">200</span> });
      tran3 = store.createRecord(<span class="string"><span class="delimiter">'</span><span class="content">transaction</span><span class="delimiter">'</span></span>, { <span class="key">amount</span>: -<span class="integer">300</span> });
      tran4 = store.createRecord(<span class="string"><span class="delimiter">'</span><span class="content">transaction</span><span class="delimiter">'</span></span>, { <span class="key">amount</span>: -<span class="integer">400</span> });

      transactions = [tran1, tran2, tran3, tran4];

      month.get(<span class="string"><span class="delimiter">'</span><span class="content">transactions</span><span class="delimiter">'</span></span>).addObjects(transactions);
    });
  }
});

test(<span class="string"><span class="delimiter">'</span><span class="content">incomeTransactions returns positive transactions</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
  expect(<span class="integer">1</span>);

  <span class="keyword">var</span> results = month.get(<span class="string"><span class="delimiter">'</span><span class="content">incomeTransactions</span><span class="delimiter">'</span></span>);

  deepEqual(results, [tran1, tran2]);
});

test(<span class="string"><span class="delimiter">'</span><span class="content">expenseTransactions returns negative transactions</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
  expect(<span class="integer">1</span>);

  <span class="keyword">var</span> results = month.get(<span class="string"><span class="delimiter">'</span><span class="content">expenseTransactions</span><span class="delimiter">'</span></span>);

  deepEqual(results, [tran3, tran4]);
});
</pre></td>
</tr></table>
</div></div>
<p><code>app/models/transaction.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre><span class="keyword">var</span> attr = DS.attr;

<span class="reserved">export</span> <span class="keyword">default</span> DS.Model.extend({
  <span class="key">amount</span>: attr(<span class="string"><span class="delimiter">'</span><span class="content">number</span><span class="delimiter">'</span></span>)
});
</pre></td>
</tr></table>
</div></div>
<p>The month controller will handle computing the <code>incomeTotal</code> and
<code>expenseTotal</code> for the month.</p>

<p><code>app/controllers/month.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
</pre></td>
  <td class="code"><pre><span class="keyword">var</span> computed = Ember.computed;

<span class="reserved">export</span> <span class="keyword">default</span> Ember.ObjectController.extend({
  <span class="key">incomeTotal</span>: computed(<span class="string"><span class="delimiter">'</span><span class="content">incomeTransactions.[]</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
    <span class="comment">// Get the amount for each transaction in incomeTransactions.</span>
    <span class="keyword">var</span> amounts = <span class="local-variable">this</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">incomeTransactions</span><span class="delimiter">'</span></span>).mapBy(<span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>);

    <span class="comment">// Sum the amounts</span>
    <span class="keyword">return</span> amounts.reduce(<span class="keyword">function</span>(previousValue, currentValue) {
      <span class="keyword">return</span> previousValue += currentValue;
    }, <span class="integer">0</span>);
  }),

  <span class="key">expenseTotal</span>: computed(<span class="string"><span class="delimiter">'</span><span class="content">expenseTransactions.[]</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
    <span class="comment">// Get the amount for each transaction in expenseTransactions.</span>
    <span class="keyword">var</span> amounts = <span class="local-variable">this</span>.get(<span class="string"><span class="delimiter">'</span><span class="content">expenseTransactions</span><span class="delimiter">'</span></span>).mapBy(<span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>);

    <span class="comment">// Sum the amounts</span>
    <span class="keyword">return</span> amounts.reduce(<span class="keyword">function</span>(previousValue, currentValue) {
      <span class="keyword">return</span> previousValue += currentValue;
    }, <span class="integer">0</span>);
  })
});
</pre></td>
</tr></table>
</div></div>
<p><code>tests/unit/controllers/month-test.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
24
25
26
27
28
29
<strong>30</strong>
31
32
33
34
35
36
37
38
39
<strong>40</strong>
41
42
43
44
45
46
47
48
49
<strong>50</strong>
51
52
53
54
55
56
57
58
59
<strong>60</strong>
61
62
63
64
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { test, moduleFor } from <span class="string"><span class="delimiter">'</span><span class="content">ember-qunit</span><span class="delimiter">'</span></span>;

<span class="keyword">var</span> set = Ember.set;

<span class="keyword">var</span> monthController, incomeTransactions, expenseTransactions;

moduleFor(<span class="string"><span class="delimiter">'</span><span class="content">controller:month</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Unit - Month Controller</span><span class="delimiter">'</span></span>, {
  <span class="function">setup</span>: <span class="keyword">function</span>() {
    incomeTransactions = [
      { <span class="key">amount</span>: <span class="integer">100</span> },
      { <span class="key">amount</span>: <span class="integer">200</span> }
    ];

    expenseTransactions = [
      { <span class="key">amount</span>: -<span class="integer">300</span> },
      { <span class="key">amount</span>: -<span class="integer">400</span> }
    ];

    monthController = <span class="local-variable">this</span>.subject({
      <span class="key">incomeTransactions</span>: incomeTransactions,
      <span class="key">expenseTransactions</span>: expenseTransactions
    });
  }
});

test(<span class="string"><span class="delimiter">'</span><span class="content">incomeTotal returns the total of all incomeTransactions</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
  expect(<span class="integer">1</span>);

  <span class="keyword">var</span> result = monthController.get(<span class="string"><span class="delimiter">'</span><span class="content">incomeTotal</span><span class="delimiter">'</span></span>);

  equal(result, <span class="integer">300</span>);
});

test(<span class="string"><span class="delimiter">'</span><span class="content">incomeTotal recomputes when an incomeTransaction is added</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
  expect(<span class="integer">1</span>);

  <span class="keyword">var</span> newTransaction = { <span class="key">amount</span>: <span class="integer">500</span> };

  monthController.get(<span class="string"><span class="delimiter">'</span><span class="content">incomeTransactions</span><span class="delimiter">'</span></span>).addObject(newTransaction);

  <span class="keyword">var</span> result = monthController.get(<span class="string"><span class="delimiter">'</span><span class="content">incomeTotal</span><span class="delimiter">'</span></span>);

  equal(result, <span class="integer">800</span>);
});

test(<span class="string"><span class="delimiter">'</span><span class="content">expenseTotal returns the total of all expenseTransactions</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
  expect(<span class="integer">1</span>);

  <span class="keyword">var</span> result = monthController.get(<span class="string"><span class="delimiter">'</span><span class="content">expenseTotal</span><span class="delimiter">'</span></span>);

  equal(result, -<span class="integer">700</span>);
});

test(<span class="string"><span class="delimiter">'</span><span class="content">expenseTotal recomputes when an expenseTransaction is added</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
  expect(<span class="integer">1</span>);

  <span class="keyword">var</span> newTransaction = { <span class="key">amount</span>: -<span class="integer">600</span> };

  monthController.get(<span class="string"><span class="delimiter">'</span><span class="content">expenseTransactions</span><span class="delimiter">'</span></span>).addObject(newTransaction);

  <span class="keyword">var</span> result = monthController.get(<span class="string"><span class="delimiter">'</span><span class="content">expenseTotal</span><span class="delimiter">'</span></span>);

  equal(result, -<span class="integer">1300</span>);
});
</pre></td>
</tr></table>
</div></div>
<p>If your spidey senses are tingling, they should be. There is a lot of
duplication going on in above code. In fact, the only difference between <code>incomeTotal</code> and
<code>expenseTotal</code> is which set of transactions they are working with (incomeTransactions
or expenseTransactions). Similarly, the only difference between <code>incomeTransactions</code> and <code>expenseTransactions</code>
is whether the amount is a positive or negative number. Let&#39;s write a couple of macros to DRY up this code.</p>

<h3>Creating custom Ember Macros</h3>

<p>Both <code>incomeTotal</code> and <code>expenseTotal</code> have almost exactly the same
logic. The goal of each is to take an array of objects and return the
sum of a specific property on each object. Let&#39;s create a <code>sumBy</code> macro
with the goal of being able to write something like: <code>sumBy(&#39;array&#39;, &#39;property&#39;)</code>.</p>

<p><code>app/utils/sum-by.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
</pre></td>
  <td class="code"><pre><span class="reserved">export</span> <span class="keyword">default</span> <span class="keyword">function</span>(collection, property) {
  <span class="keyword">return</span> Ember.reduceComputed(collection, {
    <span class="key">initialValue</span>: <span class="float">0.0</span>,

    <span class="function">addedItem</span>: <span class="keyword">function</span>(accumulatedValue, item){
      <span class="keyword">return</span> accumulatedValue + Ember.get(item, property);
    },

    <span class="function">removedItem</span>: <span class="keyword">function</span>(accumulatedValue, item){
      <span class="keyword">return</span> accumulatedValue - Ember.get(item, property);
    }
  });
}
</pre></td>
</tr></table>
</div></div>
<p><code>tests/utils/sum-by.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
24
25
26
27
28
29
<strong>30</strong>
31
32
33
34
35
36
37
38
39
<strong>40</strong>
41
42
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { test } from <span class="string"><span class="delimiter">'</span><span class="content">ember-qunit</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> sumBy from <span class="string"><span class="delimiter">'</span><span class="content">../../../utils/sum-by</span><span class="delimiter">'</span></span>;

<span class="keyword">var</span> set = Ember.set;

<span class="keyword">var</span> bankAccount, transactions, tran1, tran2, tran3, tran4;

module(<span class="string"><span class="delimiter">'</span><span class="content">Unit - SumBy</span><span class="delimiter">'</span></span>, {
  <span class="function">setup</span>: <span class="keyword">function</span>() {
    tran1 = { <span class="key">amount</span>: <span class="integer">1</span> };
    tran2 = { <span class="key">amount</span>: <span class="integer">2</span> };
    tran3 = { <span class="key">amount</span>: <span class="integer">3</span> };
    tran4 = { <span class="key">amount</span>: -<span class="integer">4</span> };

    transactions = [tran1, tran2, tran3, tran4];

    bankAccount = Ember.Object.extend({
      <span class="key">transactions</span>: transactions,
      <span class="key">totalAmount</span>: sumBy(<span class="string"><span class="delimiter">'</span><span class="content">transactions</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>)
    }).create();
  }
});

test(<span class="string"><span class="delimiter">'</span><span class="content">returns the sum of property for all objects in collection</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
  expect(<span class="integer">1</span>);
  <span class="keyword">var</span> actual = bankAccount.get(<span class="string"><span class="delimiter">'</span><span class="content">totalAmount</span><span class="delimiter">'</span></span>);

  deepEqual(actual, <span class="integer">2</span>);
});

test(<span class="string"><span class="delimiter">'</span><span class="content">recomputes when a new object is added to the collection</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {
  expect(<span class="integer">2</span>);
  deepEqual(bankAccount.get(<span class="string"><span class="delimiter">'</span><span class="content">totalAmount</span><span class="delimiter">'</span></span>), <span class="integer">2</span>, <span class="string"><span class="delimiter">'</span><span class="content">precondition</span><span class="delimiter">'</span></span>);

  <span class="keyword">var</span> newTrans = { <span class="key">amount</span>: <span class="integer">10</span> };

  bankAccount.get(<span class="string"><span class="delimiter">'</span><span class="content">transactions</span><span class="delimiter">'</span></span>).addObject(newTrans);

  <span class="keyword">var</span> actual = bankAccount.get(<span class="string"><span class="delimiter">'</span><span class="content">totalAmount</span><span class="delimiter">'</span></span>);

  deepEqual(actual, <span class="integer">12</span>);
});
</pre></td>
</tr></table>
</div></div>
<p><code>incomeTransactions</code> and <code>expenseTransactions</code> could also use some
DRYing up. The only difference between the two is whether they are
filtering by positive of negative numbers. Let&#39;s write a <code>filterBySign</code>
macro with the goal of being able to write something like: 
<code>filterBySign(&#39;array&#39;, &#39;property&#39;, &#39;+&#39;)</code>.</p>

<p><code>app/utils/filter-by-sign.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre><span class="keyword">var</span> get = Ember.get;
<span class="keyword">var</span> filter = Ember.computed.filter;

<span class="reserved">export</span> <span class="keyword">default</span> <span class="keyword">function</span>(collection, property, sign) {
  <span class="keyword">return</span> filter(collection, <span class="keyword">function</span>(object) {
    <span class="keyword">return</span> (sign + <span class="integer">1</span>) * get(object, property) &gt; <span class="integer">0</span>;
  });
}
</pre></td>
</tr></table>
</div></div>
<p><code>tests/unit/utils/filter-by-sign-test.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
24
25
26
27
28
29
<strong>30</strong>
31
32
33
34
35
36
37
38
39
<strong>40</strong>
41
42
43
44
45
46
47
48
49
<strong>50</strong>
51
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { test } from <span class="string"><span class="delimiter">'</span><span class="content">ember-qunit</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> filterBySign from <span class="string"><span class="delimiter">'</span><span class="content">../../../utils/filter-by-sign</span><span class="delimiter">'</span></span>;

<span class="keyword">var</span> bankAccount, transactions, tran1, tran2, tran3, tran4;

module(<span class="string"><span class="delimiter">'</span><span class="content">Unit - filterBySign</span><span class="delimiter">'</span></span>, {
  <span class="function">setup</span>: <span class="keyword">function</span>() {
    tran1 = { <span class="key">amount</span>: <span class="integer">1</span> };
    tran2 = { <span class="key">amount</span>: <span class="integer">2</span> };
    tran3 = { <span class="key">amount</span>: -<span class="integer">3</span> };
    tran4 = { <span class="key">amount</span>: -<span class="integer">4</span> };

    transactions = [tran1, tran2, tran3, tran4];

    bankAccount = Ember.Object.extend({
      <span class="key">transactions</span>: transactions,
      <span class="key">positiveTransactions</span>: filterBySign(<span class="string"><span class="delimiter">'</span><span class="content">transactions</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">+</span><span class="delimiter">'</span></span>),
      <span class="key">negativeTransactions</span>: filterBySign(<span class="string"><span class="delimiter">'</span><span class="content">transactions</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>)
    }).create();
  }
});

test(<span class="string"><span class="delimiter">&quot;</span><span class="content">'+' returns all objects with positive property values</span><span class="delimiter">&quot;</span></span>, <span class="keyword">function</span>() {
  expect(<span class="integer">1</span>);
  <span class="keyword">var</span> actual = bankAccount.get(<span class="string"><span class="delimiter">'</span><span class="content">positiveTransactions</span><span class="delimiter">'</span></span>);
  <span class="keyword">var</span> expected = [tran1, tran2];

  deepEqual(actual, expected);
});

test(<span class="string"><span class="delimiter">&quot;</span><span class="content">'-' returns all objects with negative property values</span><span class="delimiter">&quot;</span></span>, <span class="keyword">function</span>() {
  expect(<span class="integer">1</span>);
  <span class="keyword">var</span> actual = bankAccount.get(<span class="string"><span class="delimiter">'</span><span class="content">negativeTransactions</span><span class="delimiter">'</span></span>);
  <span class="keyword">var</span> expected = [tran3, tran4];

  deepEqual(actual, expected);
});

test(<span class="string"><span class="delimiter">'</span><span class="content">recomputes when a new object is added to the dependent array</span><span class="delimiter">'</span></span>,
<span class="keyword">function</span>() {
  expect(<span class="integer">2</span>);
  deepEqual(bankAccount.get(<span class="string"><span class="delimiter">'</span><span class="content">positiveTransactions</span><span class="delimiter">'</span></span>), [tran1, tran2]);

  <span class="keyword">var</span> newTrans = { <span class="key">amount</span>: <span class="integer">1000</span> };
  bankAccount.get(<span class="string"><span class="delimiter">'</span><span class="content">transactions</span><span class="delimiter">'</span></span>).addObject(newTrans);

  <span class="keyword">var</span> actual = bankAccount.get(<span class="string"><span class="delimiter">'</span><span class="content">positiveTransactions</span><span class="delimiter">'</span></span>);
  <span class="keyword">var</span> expected = [tran1, tran2, newTrans];

  deepEqual(actual, expected);
});
</pre></td>
</tr></table>
</div></div>
<p>When reading through the tests for <code>filterBySign</code>, note how much easier the setup is compared
to our original tests for the same functionality on the <code>Month</code> model. Because
we&#39;re testing the code in isolation, we&#39;re able to use POJOs
and arrays to test our code. This allows us to avoid having to work
around the <code>Month</code> model&#39;s relationships, creating records with the
store and wrapping our setup code in an <code>Ember.run</code> to handle async
behavior. Much nicer!</p>

<h3>Refactoring the Month Model and Controller</h3>

<p>We can now refactor our month model and controller to use our new
macros.</p>

<p><code>app/model/month.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> filterBySign from <span class="string"><span class="delimiter">'</span><span class="content">../utils/filter-by-sign</span><span class="delimiter">'</span></span>;

<span class="keyword">var</span> hasMany = DS.hasMany;

<span class="reserved">export</span> <span class="keyword">default</span> DS.Model.extend({
  <span class="key">transactions</span>: hasMany(<span class="string"><span class="delimiter">'</span><span class="content">transaction</span><span class="delimiter">'</span></span>),

  <span class="key">incomeTransactions</span>: filterBySign(<span class="string"><span class="delimiter">'</span><span class="content">transactions</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">+</span><span class="delimiter">'</span></span>),
  <span class="key">expenseTransactions</span>: filterBySign(<span class="string"><span class="delimiter">'</span><span class="content">transactions</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>)
});
</pre></td>
</tr></table>
</div></div>
<p><code>app/controllers/month.js</code></p>
<div class="highlight javascript "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> sumBy from <span class="string"><span class="delimiter">'</span><span class="content">../utils/sum-by</span><span class="delimiter">'</span></span>;

<span class="reserved">export</span> <span class="keyword">default</span> Ember.ObjectController.extend({
  <span class="key">incomeTotal</span>: sumBy(<span class="string"><span class="delimiter">'</span><span class="content">incomeTransactions</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>),
  <span class="key">expenseTotal</span>: sumBy(<span class="string"><span class="delimiter">'</span><span class="content">expenseTransactions</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">amount</span><span class="delimiter">'</span></span>)
});
</pre></td>
</tr></table>
</div></div>
<p>The refactored model and controller are nice and concise while still
maintaining their readability. We can now delete our old unit tests on
our <code>Month</code> model and controller as they now overlap with our macro tests.
The net result is trimming down the code we have to maintain by about
half.</p>

<p>If you&#39;re thinking about writing a macro or just want to see what other macros
are out there, check out <a href="https://github.com/jamesarosen/ember-cpm">ember-cpm</a>. 
It&#39;s a library of non-core macros that you can plug in to you Ember app.
If you can&#39;t find what you&#39;re looking for there, take a shot at writing
your own macro and send in a pull request to share it with the
community!</p>
</div><div class='post__share'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/2014/06/27/ember-macros-for-DRY-and-testable-code.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script><span class='post__share--github'>If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</span></div><div class='related-posts-wrap'><div class='post__avatar-wrap-is-centered'><img class='post__avatar' src='/images/team/lin-reid.jpg'><h5 class='post__avatar__name'>Lin Reid</h5><h5 class='post__avatar__position headline--sub'>Developer At DockYard
</h5><nav class='post__avatar__social-links'><a target="_blank" class="post__avatar__social-link--twitter" data-icon="#" href="http://twitter.com/linstula">linstula</a><a target="_blank" class="post__avatar__social-link--github" data-icon="★" href="https://github.com/linstula">linstula</a></nav></div></div><p class='post__tags'><a class="post__tag" href="/categories/ember.html">Ember.js&nbsp;<span class='post__tag__count'>(44)</span></a> <a class="post__tag" href="/categories/testing.html">Testing&nbsp;<span class='post__tag__count'>(11)</span></a> <a class="post__tag" href="/categories/best-practices.html">Best Practices&nbsp;<span class='post__tag__count'>(2)</span></a></p><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
</script></div><div class='push--footer'></div><footer><div class='l-wrap'><div class='l-footer-group'><h3 class='footer-group__title'>EVENTS</h3><a class="footer__event--wgc" target="_blank" href="http://wickedgoodember.com/">Wicked Good Ember Conf</a><a class="footer__event--ember" target="_blank" href="http://www.meetup.com/Boston-Ember-js/">Boston Ember.js Meetup</a><a class="footer__event--openhack" target="_blank" href="http://openhack.github.io/boston/">OpenHack Boston</a><a class="footer__event--ux" target="_blank" href="http://www.meetup.com/uxboston/">UX Boston Meetup</a><a class="footer__event--swift" target="_blank" href="http://www.meetup.com/Boston-Swift/">Boston Swift</a><a class="footer__event--uxhh" target="_blank" href="http://www.uxhappyhour.com/bos">UX Happy Hour</a></div><div class='l-footer-group'><a href="/"><h3 class='footer-group__title'>BLOG</h3></a>
<a class="footer__post" href="/2015/07/27/an-existential-redesign.html"><strong>An Existential Redesign</strong><h6 class='footer-desc'>Reflections on the experience of creating the new DockYard</h6></a>
<a class="footer__post" href="/2015/07/24/using-bare-arguments-with-ember-components.html"><strong>Using bare arguments with Ember components</strong><h6 class='footer-desc'>Positional parameters help you create cleaner APIs for your components</h6></a>
<a class="footer__post" href="/2015/07/15/color-and-culture.html"><strong>Color and culture</strong><h6 class='footer-desc'>Part 2 of 4 in the UX color series</h6></a></div><div class='l-footer-group'><a href="http://dockyard.com/hire-us"><h3 class='footer-group__title'>CONTACT</h3></a><h6 class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</h6><a class="footer__address" target="_blank" href="http://goo.gl/maps/zBGfn"><h6>DockYard Inc.<br>294 Washington St<br>Suite 1150<br>Boston, MA 02108</h6></a>
<a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='social-links--footer'><a target="_blank" data-icon="#" class="social-link" href="https://twitter.com/dockyard"><span class='is-hidden'>Twitter</span></a>
<a target="_blank" data-icon="★" class="social-link" href="https://github.com/dockyard"><span class='is-hidden'>GitHub</span></a>
<a target="_blank" data-icon="✒" class="social-link" href="/atom.xml"><span class='is-hidden'>RSS</span></a></div></div></div></footer><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
